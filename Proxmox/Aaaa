#!/bin/bash
# tailscale-lxc.sh
# Create Debian 12.12 LXC (ID 450), prepare tun, install Tailscale

CTID=450
HOSTNAME="tailscale"
DISK_SIZE="2G"
RAM="256"
IP="192.168.0.33/24"
GW="192.168.0.1"
BRIDGE="vmbr0"
TEMPLATE="debian-12-standard_12.12-1_amd64.tar.zst"

set -e

echo "[1] Updating template list..."
pveam update

echo "[2] Download Debian 12.12 template if missing..."
if ! ls /var/lib/vz/template/cache/$TEMPLATE >/dev/null 2>&1; then
  pveam download local $TEMPLATE
fi

echo "[3] Verify template exists..."
if [ ! -f /var/lib/vz/template/cache/$TEMPLATE ]; then
  echo "[ERROR] Template $TEMPLATE not found in cache after download. Exiting."
  exit 1
fi

echo "[4] Create LXC $CTID ..."
pct create $CTID local:vztmpl/$TEMPLATE \
  -hostname $HOSTNAME \
  -rootfs local-lvm:$DISK_SIZE \
  -memory $RAM \
  -swap 0 \
  -net0 name=eth0,bridge=$BRIDGE,ip=$IP,gw=$GW \
  -unprivileged 1 \
  -features nesting=1

echo "[5] Add /dev/net/tun access in config..."
CONF_FILE="/etc/pve/lxc/${CTID}.conf"
grep -q "lxc.cgroup2.devices.allow: c 10:200 rwm" $CONF_FILE || \
  echo "lxc.cgroup2.devices.allow: c 10:200 rwm" >> $CONF_FILE
grep -q "lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file" $CONF_FILE || \
  echo "lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file" >> $CONF_FILE

echo "[6] Start container..."
pct start $CTID
sleep 3

echo "[7] Check for /dev/net/tun inside container..."
if ! pct exec $CTID -- ls -l /dev/net/tun >/dev/null 2>&1; then
  echo "[ERROR] /dev/net/tun missing inside the container. Cannot continue."
  exit 1
fi

echo "[8] Install Tailscale + dependencies..."
pct exec $CTID -- bash -c "
  export DEBIAN_FRONTEND=noninteractive
  apt-get update
  apt-get install -y curl iptables iproute2 iptables-persistent
  curl -fsSL https://tailscale.com/install.sh | sh
  systemctl enable --now tailscaled
"

echo "[9] Enable IP forwarding inside container..."
pct exec $CTID -- bash -c "
  sysctl -w net.ipv4.ip_forward=1
  sysctl -w net.ipv6.conf.all.forwarding=1
  echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
  echo 'net.ipv6.conf.all.forwarding=1' >> /etc/sysctl.conf
"

echo
echo "Container $CTID ready."
echo "Enter container: pct enter $CTID"
echo "Run: tailscale up --advertise-exit-node --advertise-routes=192.168.0.0/24 --accept-dns=false"
